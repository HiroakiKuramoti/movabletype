<mt:unless name="invalid_category_set">
<div class="group-container">

  <div class="mt-collapse">
    <div class="mt-collapse__container">
      <div class="col"></div>
      <div class="col-auto">
        <a data-toggle="collapse" href="#categories-<mt:var name="content_field_id" escape="html">" aria-expanded="<mt:if name="selected_category_loop">false<mt:else>true</mt:if>" aria-controls="categories-<mt:var name="content_field_id" escape="html">"<mt:if name="selected_category_loop"> class="collapsed"</mt:if>>
          <mtapp:svgicon id="ic_collapse" title="Collapse" color="secondary">
        </a>
      </div>
    </div>
    <div class="collapse mt-collapse__content<mt:unless name="selected_category_loop"> show</mt:unless>" id="categories-<mt:var name="content_field_id" escape="html">">
      <div class="row">
        <div class="col">

          <script type="text/javascript">
          /* <![CDATA[ */
              Template.templates.categoryList = '<mt:section encode_js="1">
                  [# if ( !items.length ) { #]
                      <span class="ml-3 text-muted disabled">[#|h trans("None selected") #]</span>
                      [#* return #]
                  [# } #]
                  <ul class="list-unstyled ml-3 category-list">
                  [# var map = {}; #]
                  [# for ( var i = 0; i < items.length; i++ ) { #]
                      [# if ( items[ i ] == 0 && i == 0 ) { #]
                          [#-- special case, no primary selected, but has secondaries --#]
                          [# continue #]
                      [# } #]
                      [# var cat = cache.getItem( "cat:"+items[ i ] ); #]
                      [# if ( !cat ) continue; #]
                      [# var label; #]
                      [# if ( cat.path.length ) {
                          label = [];
                          for ( var j = 0; j < cat.path.length; j++ ) {
                              var c = cache.getItem( "cat:"+cat.path[ j ] );
                              if ( c )
                                  label.push( c.label );
                          }
                          label.push( cat.label );
                          for ( var j = 0; j < label.length; j++ )
                              label[ j ] = context.f.h( label[ j ] );
                          label = label.join( ' &raquo; ' );
                      } else {
                          label = context.f.h( cat.label );
                      } #]
                      [# if ( multiple ) { #]
                          [# if ( i == 0 ) { #]
                          <li class="primary" mt:focus-hover="1" mt:id="[#= cat.id #]"><mtapp:svgicon id="ic_fav" title="Primary" size="sm"><strong>[#= label #]</strong><a href="javascript:void(0);" mt:command="remove" class="ml-1 delete" title="[#|h trans("Remove") #]"><span class="d-inline-block"><mtapp:svgicon id="ic_remove" title="Remove" size="sm"></span></a></li>
                          [# } else { #]
                          <li style="margin-left: 1.1rem;" mt:focus-hover="1" mt:id="[#= cat.id #]"><a mt:focus-hover="1" href="javascript:void(0);" mt:command="primary" class="primary" title="[#|h trans("Make primary") #]">[#= label #]</a><a mt:focus-hover="1" href="javascript:void(0);" mt:command="remove" class="ml-1 delete d-inline-block" title="[#|h "Remove" #]"><mtapp:svgicon id="ic_remove" title="Remove" size="sm"></a></li>
                          [# } #]
                      [# } else { #]
                      <li mt:focus-hover="1" mt:id="[#= cat.id #]">[#= label #]</li>
                      [# } #]
                  [# } #]
                  </ul>
              </mt:section>';

              Template.templates.categorySelectorList<mt:var name="content_field_id" escape="js"> = '<mt:section encode_js="1">
                      [# if ( item.path == null ) item.path = [] #]
                      <div style="text-align:left; margin-left:[#= item.path.length * 10 #]px">
                          <div class="custom-control <mt:if name="options{multiple}">custom-checkbox<mt:else>custom-radio</mt:if>" style="width: [#= 165 - (item.path.length * 10) #]px;">
                              <input type="<mt:if name="options{multiple}">checkbox<mt:else>radio</mt:if>" name="content-field-<mt:var name="content_field_id">" id="content-field-<mt:var name="content_field_id">-[#= item.id #]" class="custom-control-input add-category-checkbox category group content-field" value="[#= item.id #]" <mt:if name="category_is_selected">checked="checked"</mt:if> mt:watch-change="1" mt:raw-name="1" />
                              <label class="custom-control-label" for="content-field-<mt:var name="content_field_id">-[#= item.id #]">
                                  [#|h item.label #]
                              </label>
                          <mt:if name="options{can_add}">
                              <a href="javascript:void(0);" mt:id="[#= item.id #]" mt:content-field-id="<mt:var name="content_field_id" escape="html">" mt:command="show-add-category" class="add-category-new-link"><span class="d-inline-block"><mtapp:svgicon id="ic_add" title="Add" size="sm"></span></a>
                          </mt:if>
                          </div>
                      </div>
              </mt:section>';

              Template.templates.categorySelectorAddForm = '<mt:section encode_js="1">
              [# div.className="form-inline add-category-form hidden" #]<input id="add-category-input-movable-[#= contentFieldId #]" class="form-control add-category-input input-hint" type="text" value="" placeholder="[#|h trans( "Add sub category" ) #]" /> <a href="javascript:void(0);" mt:command="add" class="add-category-save-link"><span class="d-inline-block"><mtapp:svgicon id="ic_add" title="Add" size="sm"></span></a><a href="javascript:void(0);" mt:command="cancel" class="add-category-cancel-link"><span class="d-inline-block"><mtapp:svgicon id="ic_remove" title="Remove" size="sm"></span></a>
              </mt:section>';

              new Timer(function () {
                  var selectedCategoryList = <$mt:if name="selected_category_loop"><$mt:var name="selected_category_loop" to_json="1"$><mt:else>[]</mt:if>;
                  var categoryList = <$mt:if name="category_tree"><$mt:var name="category_tree" to_json="1" regex_replace="/(s)(cript)/ig","$1\$2"$><mt:else>[]</mt:if>;

                  var categorySetId = <mt:if name="options{category_set}"><mt:var name="options{category_set}" escape="js"><mt:else>0</mt:if>;
                  var contentFieldId = <mt:var name="content_field_id" escape="js">;

                  var catCache = new Cache( categoryList.length + 50 );
                  for ( var i = 0; i < categoryList.length; i++ ) {
                      catCache.setItem( 'cat:'+categoryList[ i ].id, categoryList[ i ] );
                  }
                  var list = new MT.App.CategoryList(
                      'category-list-' + contentFieldId,
                      {
                          catCache: catCache,
                          contentFieldId: contentFieldId,
                          multiple: <mt:if name="options{multiple}">true<mt:else>false</mt:if>,
                          selectedCategoryList: selectedCategoryList
                      }
                  );
                  app.setDelegate( "categoryList", list );
                  list.redraw( catCache );

                  if ( !app.fieldCategorySelectors ) {
                      app.fieldCategorySelectors = {};
                  }

                  var selector = app.fieldCategorySelectors[contentFieldId] = new MT.App.CategorySelector(
                      '<mt:if name="options{multiple}">category<mt:else>folder</mt:if>-selector-' + contentFieldId,
                      'categorySelectorList' + contentFieldId,
                      {
                          categorySetId: categorySetId,
                          categoryList: categoryList,
                          catCache: catCache,
                          catForm: 'add-category-form-' + contentFieldId,
                          catInput: 'add-category-input-' + contentFieldId,
                          catInputMovableId: 'add-category-input-movable-' + contentFieldId,
                          catList: list,
                          contentFieldId: contentFieldId,
                          selectedCategoryList: selectedCategoryList
                      }
                  );
                  selector.redraw();
                  selector.open();

              }, 100, 1);
          /* ]]> */
          </script>

          <div id="<mt:if name="options{multiple}">category<mt:else>folder</mt:if>-selector-<mt:var name="content_field_id" escape="html">" class="category-selector hidden" style="display: none;">
          <mt:if name="options{can_add}">
              <div class="category-selector-header">
                  <a class="add-category-new-parent-link d-inline-block" mt:command="show-add-category" href="javascript:void(0);" title="<$mt:var name="add_new_container_label_parent"$>"><mtapp:svgicon id="ic_add" title="<__trans phrase="Add">" size="sm"><__trans phrase="Add"></a>
              </div>
              <div id="add-category-form-<mt:var name="content_field_id" escape="html">" class="form-inline add-category-form hidden" style="display: none;">
                  <input id="add-category-input-<mt:var name="content_field_id" escape="html">" class="form-control add-category-input input-hint" type="text" value="" placeholder="<__trans phrase="Category Name">" />
                  <a href="javascript:void(0);" mt:command="add" class="add-category-save-link"><span class="d-inline-block"><mtapp:svgicon id="ic_add" title="<__trans phrase="Add">" size="sm"></span></a>
                  <a href="javascript:void(0);" mt:command="cancel" class="add-category-cancel-link"><span class="d-inline-block"><mtapp:svgicon id="ic_remove" title="<__trans phrase="Remove">" size="sm"></span></a>
              </div>
          </mt:if>
              <div id="<mt:if name="options{multiple}">category<mt:else>folder</mt:if>-selector-<mt:var name="content_field_id" escape="html">-list" class="card mt-2 p-2 category-selector-list"></div>
          </div><!-- /category-selector -->

        </div>
      </div>
    </div>
    <div class="mt-collapse__container">
      <div class="col">
        <div mt:delegate="category-list" id="category-list-<mt:var name="content_field_id" escape="html">" class="category-list-container" mt:content-field-id="<mt:var name="content_field_id" escape="html">"></div>
        <input id="category-ids-<mt:var name="content_field_id" escape="js">" type="hidden" style="display: none;" name="category-<mt:var name="content_field_id" escape="html">" value="<$mt:var name="selected_category_loop" glue=","$>" <mt:var name="required"> <mt:var name="multiple"> />
      </div>
    </div>
  </div>

</div>
<mt:else>
<div class="alert alert-warning">
  <__trans phrase="This field is disabled because valid Category Set is not selected in this field.">
</div>
</mt:unless>
