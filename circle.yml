machine:
  services:
    - docker

checkout:
  post:
    - t/git-mtime t/cpanfile t/ldif/cn=config.ldif t/ldif/domain1_example_jp.ldif t/ldif/domain2_example_jp.ldif t/ldif/example_com.ldif t/ldif/example_jp.ldif

dependencies:
  cache_directories:
    - "~/docker"

  override:
    - cp ./t/mysql-test.cfg ./mt-config.cgi
    - rm t/62-asset-editor.t
    - rm plugins/MultiBlog/t/02.tags.t

    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -t mt .
    - mkdir -p ~/docker; docker save mt > ~/docker/image.tar

test:
  override:
    - docker run -w /var/www/mt mt bash -c "cp ./t/mysql-test.cfg ./mt-config.cgi && rm t/62-asset-editor.t plugins/MultiBlog/t/02.tags.t && service mysqld start & sleep 10 && service memcached start & sleep 10 && prove ./t ./plugins/*/t && phpunit"
